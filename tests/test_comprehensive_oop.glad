PRINTLN "=== GLADLANG MASTER OOP TEST SUITE ===\n"

# --- HELPER TO CATCH ERRORS ---
DEF assert_error(fn_wrapper, test_name)
  TRY
    fn_wrapper()
    PRINTLN "[FAIL] " + test_name + " (Expected Error, but got Success)"
  CATCH e
    PRINTLN "[PASS] " + test_name + " (Caught: " + STR(e) + ")"
  ENDTRY
ENDDEF

# ==========================================
# SETUP CLASSES
# ==========================================

CLASS Base
  PROTECTED DEF secret_family_recipe()
    RETURN "Grandma's Secret Sauce"
  ENDDEF
ENDCLASS

CLASS Child INHERITS Base
  DEF Child(name)
    THIS.name = name
    PRIVATE THIS.diary = "My Secrets"
  ENDDEF

  PUBLIC DEF get_name()
    RETURN THIS.name
  ENDDEF

  PUBLIC DEF reveal_family_secret()
    RETURN THIS.secret_family_recipe()
  ENDDEF

  PRIVATE DEF get_diary()
    RETURN THIS.diary
  ENDDEF

  PUBLIC DEF read_peer_diary(other_child)
    RETURN other_child.get_diary()
  ENDDEF
ENDCLASS

CLASS Stranger
  DEF Stranger()
  ENDDEF
  
  PUBLIC DEF try_steal(target)
    RETURN target.get_diary()
  ENDDEF
ENDCLASS

# ==========================================
# EXECUTE BASIC TESTS (1-11)
# ==========================================

LET alice = NEW Child("Alice")
LET bob = NEW Child("Bob")
LET stranger = NEW Stranger()


PRINTLN "--- TEST 1: Public Method Access ---"
IF alice.get_name() == "Alice" THEN
  PRINTLN "[PASS] Public method works"
ELSE
  PRINTLN "[FAIL] Public method returned wrong value"
ENDIF


PRINTLN "\n--- TEST 2: Private Method Access (External) ---"
DEF test2_wrapper()
  alice.get_diary()
ENDDEF
assert_error(test2_wrapper, "External Private Method Call")


PRINTLN "\n--- TEST 3: Private Attribute Access (External) ---"
DEF test3_wrapper()
  PRINTLN alice.diary
ENDDEF
assert_error(test3_wrapper, "External Private Attribute Access")


PRINTLN "\n--- TEST 4: Protected Method Access (From Subclass) ---"
TRY
  IF alice.reveal_family_secret() == "Grandma's Secret Sauce" THEN
    PRINTLN "[PASS] Subclass accessed PROTECTED parent method"
  ELSE
    PRINTLN "[FAIL] Subclass got wrong value from protected method"
  ENDIF
CATCH e
  PRINTLN "[FAIL] Subclass blocked from protected method: " + STR(e)
ENDTRY


PRINTLN "\n--- TEST 5: Protected Method Access (External) ---"
DEF test5_wrapper()
  alice.secret_family_recipe()
ENDDEF
assert_error(test5_wrapper, "External Protected Method Call")


PRINTLN "\n--- TEST 6: Static Security Bypass (Method) ---"
DEF test6_wrapper()
  LET stolen_method = Child.get_diary
  stolen_method(alice) 
ENDDEF
assert_error(test6_wrapper, "Static Class Bypass Attempt")


PRINTLN "\n--- TEST 7: Peer Access (Same Class) ---"
TRY
  IF alice.read_peer_diary(bob) == "My Secrets" THEN
    PRINTLN "[PASS] Peer object accessed private member of same class"
  ELSE
    PRINTLN "[FAIL] Peer access returned wrong value"
  ENDIF
CATCH e
  PRINTLN "[FAIL] Peer access blocked: " + STR(e)
ENDTRY


PRINTLN "\n--- TEST 8: Stranger Danger ---"
DEF test8_wrapper()
  stranger.try_steal(alice)
ENDDEF
assert_error(test8_wrapper, "Stranger Class accessing Private Method")


PRINTLN "\n--- TEST 9: Visibility Override (Property) ---"
CLASS DataContainer
  DEF DataContainer()
    PUBLIC THIS.data = "Public"
  ENDDEF
  
  PUBLIC DEF make_private()
    PRIVATE THIS.data = "Now Private"
  ENDDEF
ENDCLASS

LET d = NEW DataContainer()
PRINTLN "Initial State: " + d.data
d.make_private()
PRINTLN "Made Private. Attempting access..."

DEF test9_wrapper()
  PRINTLN d.data
ENDDEF
assert_error(test9_wrapper, "Property Visibility Changed at Runtime")


PRINTLN "\n--- TEST 10: Deep Inheritance ---"
CLASS GrandChild INHERITS Child
  DEF GrandChild()
  ENDDEF
  
  PUBLIC DEF access_grandparent()
    RETURN THIS.secret_family_recipe()
  ENDDEF
ENDCLASS

LET junior = NEW GrandChild()
TRY
  IF junior.access_grandparent() == "Grandma's Secret Sauce" THEN
    PRINTLN "[PASS] Deep inheritance (GrandChild -> Base) works"
  ELSE
    PRINTLN "[FAIL] Deep inheritance returned wrong value"
  ENDIF
CATCH e
  PRINTLN "[FAIL] Deep inheritance blocked: " + STR(e)
ENDTRY


PRINTLN "\n--- TEST 11: Private Field Shadowing (Name Mangling) ---"
CLASS ParentShadow
  DEF ParentShadow()
    PRIVATE THIS.secret = "Parent Secret"
  ENDDEF
  
  PUBLIC DEF get_parent_secret()
    RETURN THIS.secret
  ENDDEF
ENDCLASS

CLASS ChildShadow INHERITS ParentShadow
  DEF ChildShadow()
    # Manual super call workaround
    ParentShadow.ParentShadow(THIS)
    # This should NOT overwrite the parent's private 'secret'
    PRIVATE THIS.secret = "Child Secret"
  ENDDEF
  
  PUBLIC DEF get_child_secret()
    RETURN THIS.secret
  ENDDEF
ENDCLASS

LET shadow = NEW ChildShadow()

TRY
  LET p_secret = shadow.get_parent_secret()
  LET c_secret = shadow.get_child_secret()
  
  PRINTLN "Parent Secret: " + p_secret
  PRINTLN "Child Secret:  " + c_secret
  
  IF p_secret == "Parent Secret" AND c_secret == "Child Secret" THEN
    PRINTLN "[PASS] Name Mangling Successful (Variables did not collide)"
  ELSE
    PRINTLN "[FAIL] Name Mangling Failed (Variables collided or overwrote each other)"
  ENDIF
CATCH e
  PRINTLN "[FAIL] Error during shadowing test: " + STR(e)
ENDTRY


# ==========================================
# EXECUTE NEW EDGE CASE TESTS (12-14)
# ==========================================

PRINTLN "\n--- TEST 12: LSP Violation Check (Strict Visibility) ---"
# Attempt to define a class that hides a Public parent method
DEF test12_wrapper()
  CLASS ParentLSP
    PUBLIC DEF hello() 
      PRINTLN "Hi" 
    ENDDEF
  ENDCLASS

  CLASS BadChild INHERITS ParentLSP
    PRIVATE DEF hello() 
      PRINTLN "Hidden" 
    ENDDEF
  ENDCLASS
ENDDEF
assert_error(test12_wrapper, "Subclass strictly reducing visibility")


PRINTLN "\n--- TEST 13: Singleton Pattern (Factory Method) ---"
CLASS Singleton
  # Constructor must be PUBLIC (Strict Private Constructors are not supported)
  PUBLIC DEF Singleton()
    THIS.value = 1
  ENDDEF

  PUBLIC DEF get_instance()
    # Factory method returning a new instance
    RETURN NEW Singleton()
  ENDDEF
ENDCLASS

TRY
  # Simulate a static call by passing the class itself as 'THIS'
  LET fn = Singleton.get_instance
  LET s = fn(Singleton)
  
  IF s.value == 1 THEN
    PRINTLN "[PASS] Singleton instantiated via factory method"
  ELSE
    PRINTLN "[FAIL] Singleton instance invalid"
  ENDIF
CATCH e
  PRINTLN "[FAIL] Factory method failed: " + STR(e)
ENDTRY

PRINTLN "\n--- TEST 14: Final Variable Protection ---"
CLASS SecureConst
  DEF SecureConst()
    FINAL THIS.MAX_USERS = 100
    
    # Attack: Try to shadow it with a private variable (which deletes the public one)
    PRIVATE THIS.MAX_USERS = 50
  ENDDEF
ENDCLASS

DEF test14_wrapper()
  NEW SecureConst()
ENDDEF
assert_error(test14_wrapper, "Shadowing a FINAL public variable")


PRINTLN "\n=== SUITE COMPLETE ==="